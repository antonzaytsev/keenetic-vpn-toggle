services:
  backend:
    build: ./backend
    network_mode: host
    stdin_open: true
    tty: true
    environment:
      - KEENETIC_HOST=${KEENETIC_HOST:-192.168.1.1}
      - KEENETIC_LOGIN=${KEENETIC_LOGIN:-admin}
      - KEENETIC_PASSWORD=${KEENETIC_PASSWORD}
      - VPN_POLICY=${VPN_POLICY:-!WG1}
      - RACK_ENV=development
      - BUNDLE_PATH=/bundle
      - PORT=${BACKEND_PORT:-4567}
      - RACK_ALLOWED_HOSTS=.internal,localhost,0.0.0.0
    command: sh -c "bundle install && bundle exec puma -C config/puma.rb"
    volumes:
      - ./backend:/app
      - bundle:/bundle

  frontend:
    build: ./frontend
    network_mode: host
    environment:
      - NODE_ENV=development
      - VITE_PORT=${FRONTEND_PORT:-3000}
      - VITE_BACKEND_HOST=${BACKEND_HOST:-}
      - VITE_BACKEND_PORT=${BACKEND_PORT:-4567}
    command: sh -c "pnpm install && pnpm dev"
    volumes:
      - ./frontend:/app
      - node_modules:/app/node_modules

volumes:
  bundle:
  node_modules:
